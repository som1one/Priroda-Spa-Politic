# Интеграция с YClients

## Описание

Полная интеграция с YClients для управления бронированиями. Поддерживается два режима работы:

1. **YClients виджет (WebView)** - для услуг, привязанных к YClients
2. **Собственный календарь** - для услуг без привязки к YClients

## Настройка

### 1. Получение API ключей YClients

#### Способ 1: Через веб-интерфейс (рекомендуется)

1. **Войдите в личный кабинет YClients**
   - Откройте https://yclients.com
   - Войдите в свой аккаунт

2. **Найдите раздел API**
   - В меню выберите **"Настройки"** (или **"Администрирование"**)
   - Найдите раздел **"API"** или **"Интеграции"**
   - Или перейдите напрямую: **"Настройки → Интеграции → API"**

3. **Создайте/скопируйте токены**
   - **API Token** (или **Partner Token**) - это `YCLIENTS_API_TOKEN`
   - **User Token** (или **User Partner Token**) - это `YCLIENTS_USER_TOKEN`
   - Если токенов нет - нажмите **"Создать токен"** или **"Добавить API ключ"**

4. **Найдите ID компании**
   - В URL страницы вашей компании: `https://yclients.com/timetable/123456`
   - Число `123456` - это `YCLIENTS_COMPANY_ID`
   - Или в **"Настройки → Информация о компании"** → ID компании

#### Способ 2: Через поддержку YClients

Если не нашли раздел API в интерфейсе:

1. **Обратитесь в поддержку:**
   - Email: support@yclients.com
   - Телефон: 8-800-500-33-83 (бесплатно по России)
   - Онлайн-чат на сайте yclients.com

2. **Скажите, что вам нужны:**
   - API Token для интеграции
   - User Token для интеграции
   - ID компании

3. **Обычно они предоставляют:**
   - Документацию по API
   - Токены для доступа
   - Примеры использования

#### Способ 3: Через партнёрский портал

1. Зарегистрируйтесь как партнёр: https://api.yclients.com
2. Получите доступ к API документации
3. Создайте токены через партнёрский интерфейс

#### Важные моменты:

⚠️ **Безопасность:**
- Токены дают полный доступ к вашим данным
- Не публикуйте их в открытом доступе
- Не коммитьте `.env` файл в Git
- Используйте разные токены для dev/prod

⚠️ **Права доступа:**
- Убедитесь, что токены имеют права на:
  - Чтение услуг
  - Чтение расписания
  - Создание записей
  - Чтение мастеров

⚠️ **Формат токенов:**
- API Token обычно длинная строка (32+ символов)
- User Token может быть такой же или другой
- Если не уверены - используйте один токен для обоих полей (временно)

### 2. Настройка переменных окружения

Добавьте в `.env` файл:

```env
YCLIENTS_ENABLED=True
YCLIENTS_COMPANY_ID=123456
YCLIENTS_API_TOKEN=your-api-token
YCLIENTS_USER_TOKEN=your-user-token
```

### 3. Привязка услуг к YClients

В админ-панели при редактировании услуги укажите:
- **YClients Service ID** - ID услуги в YClients
- **YClients Staff ID** (опционально) - ID мастера в YClients

Или через миграцию/админку добавьте поля:
- `yclients_service_id` - ID услуги в YClients
- `yclients_staff_id` - ID мастера (опционально)

## Как это работает

### Сценарий 1: Услуга привязана к YClients

```
1. Пользователь выбирает услугу
   ↓
2. Проверяется наличие yclients_service_id
   ↓
3. Переход на YClientsBookingScreen (WebView)
   ↓
4. Загрузка виджета YClients через API
   ↓
5. Пользователь бронирует через виджет YClients
   ↓
6. После бронирования возврат в приложение
```

### Сценарий 2: Услуга НЕ привязана к YClients

```
1. Пользователь выбирает услугу
   ↓
2. yclients_service_id отсутствует
   ↓
3. Переход на BookingScreen (наш календарь)
   ↓
4. Выбор даты/времени через наш интерфейс
   ↓
5. Создание бронирования в нашей БД
```

## API Endpoints

### Получить URL виджета YClients

```
GET /api/v1/yclients/widget-url/{service_id}
Headers: Authorization: Bearer {token}

Response:
{
  "widget_url": "https://yclients.com/timetable/123456?services=789",
  "service_id": 1,
  "service_name": "Массаж"
}
```

### Получить доступные даты/время (для будущего использования)

```
GET /api/v1/yclients/available-dates/{service_id}?staff_id=123&date_from=2024-01-01&date_to=2024-01-31
Headers: Authorization: Bearer {token}

Response:
{
  "service_id": 1,
  "service_name": "Массаж",
  "available_dates": [
    {
      "date": "2024-01-15",
      "times": ["10:00", "11:00", "14:00", "15:00"]
    },
    ...
  ]
}
```

### Создать запись в YClients (для будущего использования)

```
POST /api/v1/yclients/book/{service_id}
Headers: Authorization: Bearer {token}
Body: {
  "datetime_str": "2024-01-15 10:00",
  "client_name": "Иван Иванов",
  "client_phone": "+79991234567",
  "client_email": "ivan@example.com",
  "comment": "Комментарий"
}

Response:
{
  "success": true,
  "yclients_booking_id": 12345,
  "booking": {...}
}
```

## Миграция базы данных

Выполните миграцию для добавления полей:

```bash
cd backend
alembic upgrade head
```

Это добавит поля:
- `services.yclients_service_id` - ID услуги в YClients
- `services.yclients_staff_id` - ID мастера в YClients

## Настройка услуг в админ-панели

1. Откройте админ-панель → SPA-меню
2. Выберите услугу для редактирования
3. В форме редактирования добавьте поля:
   - **YClients Service ID** - ID услуги из YClients
   - **YClients Staff ID** (опционально) - ID мастера

## Преимущества

✅ **Автоматическая синхронизация** - записи создаются в YClients  
✅ **Реальные доступные слоты** - виджет показывает только свободное время  
✅ **Управление мастерами** - можно привязать услугу к конкретному мастеру  
✅ **Гибкость** - можно использовать и наш календарь, и YClients  
✅ **Единый интерфейс** - пользователь не замечает переключения  

## Обработка ошибок

- Если YClients не настроен → показывается наш календарь
- Если услуга не привязана → используется наш календарь
- Если виджет не загрузился → показывается ошибка с кнопкой "Повторить"
- Если API недоступен → fallback на наш календарь

## Дополнительные возможности

В будущем можно добавить:
- Получение доступных слотов через API и отображение в нашем календаре
- Синхронизацию записей в обе стороны
- Webhook от YClients для обновления статусов
- Интеграцию с календарём мастеров


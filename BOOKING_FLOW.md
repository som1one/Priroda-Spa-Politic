# Схема процесса бронирования услуги

## Полный флоу от выбора услуги до завершения бронирования

```
┌─────────────────────────────────────────────────────────────────┐
│                   1. ВЫБОР УСЛУГИ                                │
│                   (MenuSpaScreen)                               │
│                                                                  │
│  • Загрузка меню: GET /api/v1/menu/tree                        │
│  • Отображение категорий и услуг                               │
│  • Навигация по категориям/подкатегориям                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [Нажатие на услугу]
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│             2. ДЕТАЛИ УСЛУГИ                                    │
│             (ServiceDetailScreen)                               │
│                                                                  │
│  • Загрузка услуги: GET /api/v1/services/{serviceId}           │
│  • Отображение:                                                  │
│    - Изображение услуги                                         │
│    - Название и подзаголовок                                    │
│    - Описание                                                   │
│    - Цена и длительность                                        │
│    - Дополнительные услуги                                      │
│    - Highlights (теги)                                         │
│  • Кнопки:                                                      │
│    - "Связаться" (если есть contactLink)                        │
│    - "Быстрое бронирование"                                     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [Быстрое бронирование]
                            │ Передача: serviceId, service
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        3. ШАГ 1: ВЫБОР ДАТЫ И ВРЕМЕНИ                           │
│           (BookingScreen)                                       │
│                                                                  │
│  Прогресс-бар: [1 Дата и время] → 2 Детали → 3 Оплата → 4 Подтв│
│                                                                  │
│  • Загрузка услуги: GET /api/v1/services/{serviceId}            │
│    (если не передана)                                           │
│  • Загрузка пользователя: GET /api/v1/auth/me                  │
│                                                                  │
│  Функционал:                                                     │
│  • Календарь для выбора даты:                                    │
│    - Навигация по месяцам                                       │
│    - Выделение выбранной даты (зелёный круг)                   │
│    - Недоступные даты (прошедшие) серым                         │
│    - Доступны даты на 90 дней вперёд                            │
│                                                                  │
│  • Горизонтальный список временных слотов:                       │
│    - 09:00, 10:00, 11:00, 12:00, 13:00, 14:00,                 │
│      15:00, 16:00, 17:00, 18:00, 19:00, 20:00                  │
│    - Выбранное время: зелёный фон, белый текст                   │
│    - Для сегодняшней даты фильтруются прошедшие времена         │
│    - Минимальное время: текущее + 1 час                          │
│                                                                  │
│  • Кнопка "Подтвердить бронирование":                            │
│    - Активна только при выборе даты И времени                   │
│    - Переход на следующий шаг                                    │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [Подтвердить бронирование]
                            │ Передача: serviceId, service,
                            │           appointmentDateTime
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│           4. ШАГ 2: ДЕТАЛИ БРОНИРОВАНИЯ                         │
│           (BookingDetailsScreen)                                │
│                                                                  │
│  Прогресс-бар: 1 ✓ → [2 Детали] → 3 Оплата → 4 Подтв           │
│                                                                  │
│  • Загрузка услуги: GET /api/v1/services/{serviceId}            │
│    (если не передана)                                           │
│  • Загрузка пользователя: GET /api/v1/auth/me                  │
│                                                                  │
│  Отображение:                                                    │
│  • Информация о записи:                                          │
│    - Дата и время (из предыдущего шага)                         │
│                                                                  │
│  • Дополнительные услуги (если есть):                           │
│    - Чекбоксы для выбора                                         │
│    - Иконки для разных типов услуг                              │
│                                                                  │
│  • Контактные данные:                                            │
│    - Телефон (автозаполнение из профиля)                        │
│    - Валидация телефона                                         │
│                                                                  │
│  • Комментарий (необязательно):                                  │
│    - Текстовое поле для пожеланий                               │
│                                                                  │
│  • Итоговая стоимость:                                           │
│    - Базовая цена услуги                                        │
│    - TODO: Добавить цены для дополнительных услуг               │
│                                                                  │
│  • Кнопка "Продолжить к оплате"                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [Продолжить к оплате]
                            │ Передача: serviceId, serviceName,
                            │           servicePrice, appointmentDateTime,
                            │           duration, phone, notes,
                            │           additionalServices
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│             5. ШАГ 3: ОПЛАТА                                    │
│             (PayScreen)                                         │
│                                                                  │
│  Прогресс-бар: 1 ✓ → 2 ✓ → [3 Оплата] → 4 Подтв               │
│                                                                  │
│  • Загрузка баллов лояльности: GET /api/v1/loyalty/info         │
│                                                                  │
│  Форма оплаты:                                                   │
│  • Детали карты:                                                 │
│    - Номер карты (0000 0000 0000 0000)                          │
│      • Иконка: credit_card                                     │
│      • Автоформатирование: 4 цифры + пробел                     │
│      • Валидация: 13-19 цифр                                     │
│                                                                  │
│    - Срок действия (ММ/ГГ)                                      │
│      • Иконка: calendar_today                                   │
│      • Автоформатирование: ММ/ГГ                                │
│      • Валидация: месяц 1-12, год >= текущий                    │
│                                                                  │
│    - CVV (***)                                                  │
│      • Иконка: lock_outline                                     │
│      • Скрытый ввод                                             │
│      • Валидация: 3-4 цифры                                     │
│                                                                  │
│    - Имя владельца карты                                        │
│      • Иконка: person_outline                                   │
│      • Плейсхолдер: "Имя на карте"                              │
│      • Валидация: обязательное поле                             │
│                                                                  │
│  • Мобильная оплата:                                             │
│    - Apple Pay (чёрная кнопка)                                   │
│    - Google Pay (белая кнопка)                                   │
│                                                                  │
│  • Использовать баллы лояльности:                               │
│    - Показывается только если есть баллы                        │
│    - Отображение доступных баллов                                │
│    - Переключатель для активации                                 │
│                                                                  │
│  • Кнопка "Оплатить":                                            │
│    - Валидация всех полей                                        │
│    - Имитация обработки платежа (1 сек)                          │
│    - Создание бронирования на сервере                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [Оплатить]
                            │ POST /api/v1/bookings
                            │ Body: {
                            │   service_name: string,
                            │   service_duration: int?,
                            │   service_price: int? (в копейках),
                            │   appointment_datetime: ISO string,
                            │   notes: string?,
                            │   phone: string?
                            │ }
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        6. ШАГ 4: ПОДТВЕРЖДЕНИЕ БРОНИРОВАНИЯ                     │
│        (Диалог подтверждения)                                  │
│                                                                  │
│  Прогресс-бар: 1 ✓ → 2 ✓ → 3 ✓ → [4 Подтв]                    │
│                                                                  │
│  • Ответ от сервера: BookingResponse                            │
│    - id, user_id, service_name                                  │
│    - appointment_datetime                                        │
│    - status: "pending"                                           │
│    - created_at, updated_at                                     │
│                                                                  │
│  • Отправка email подтверждения (background task):              │
│    - send_booking_confirmation()                                │
│                                                                  │
│  Диалог:                                                        │
│  • Иконка: check_circle (зелёная)                               │
│  • Заголовок: "Вы записаны!"                                     │
│  • Сообщение: "Ваша запись успешно создана..."                  │
│  • Детали записи:                                                │
│    - Услуга                                                      │
│    - Дата и время                                                │
│    - Цена                                                        │
│  • Кнопка "OK"                                                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ [OK]
                            │ Navigator.pushNamedAndRemoveUntil('/')
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   7. ГЛАВНЫЙ ЭКРАН                               │
│                   (HomeScreen)                                  │
│                                                                  │
│  • Обновление данных пользователя                                │
│  • Отображение активных бронирований                            │
└─────────────────────────────────────────────────────────────────┘
```

## API Endpoints

### 1. Получение меню
```
GET /api/v1/menu/tree
Response: MenuTreeResponse
```

### 2. Получение услуги
```
GET /api/v1/services/{serviceId}
Response: ServiceResponse
```

### 3. Получение профиля пользователя
```
GET /api/v1/auth/me
Headers: Authorization: Bearer {token}
Response: UserProfile
```

### 4. Получение информации о лояльности
```
GET /api/v1/loyalty/info
Headers: Authorization: Bearer {token}
Response: LoyaltyInfoResponse
```

### 5. Создание бронирования
```
POST /api/v1/bookings
Headers: Authorization: Bearer {token}
Body: {
  service_name: string,
  service_duration: int?,
  service_price: int? (в копейках),
  appointment_datetime: ISO string (UTC),
  notes: string?,
  phone: string?
}
Response: BookingResponse
```

## Модели данных

### Service
- id, name, subtitle, description
- price, duration
- imageUrl, detailImageUrl
- additionalServices: List<Map>
- highlights: List<String>
- contactLink, contactLabel, bookButtonLabel

### Booking
- id, user_id, service_name
- service_duration, service_price
- appointment_datetime
- status: "pending" | "confirmed" | "completed" | "cancelled"
- notes, phone
- created_at, updated_at

### LoyaltyInfo
- current_points
- current_level: LoyaltyLevel?
- next_level: LoyaltyLevel?
- points_to_next
- progress: float (0.0 - 1.0)
- available_bonuses: List<LoyaltyBonus>

## Состояния и валидация

### BookingScreen
- ✅ Дата выбрана
- ✅ Время выбрано
- ✅ Дата в будущем
- ✅ Время доступно (не в прошлом для сегодня)

### BookingDetailsScreen
- ✅ Телефон валиден (минимум 10 цифр)
- ✅ Форма валидна

### PayScreen
- ✅ Номер карты: 13-19 цифр
- ✅ Срок действия: ММ/ГГ, месяц 1-12, год >= текущий
- ✅ CVV: 3-4 цифры
- ✅ Имя владельца: не пустое
- ✅ Все поля заполнены

## Обработка ошибок

- **Ошибка загрузки услуги**: Показ ошибки с кнопкой "Повторить"
- **Ошибка создания бронирования**: SnackBar с сообщением об ошибке
- **Ошибка загрузки лояльности**: Секция с баллами не показывается
- **Сетевые ошибки**: Показ понятных сообщений пользователю

## Особенности реализации

1. **Кэширование**: Данные пользователя кэшируются в `UserService`
2. **Автозаполнение**: Телефон подтягивается из профиля пользователя
3. **Фильтрация времени**: Для сегодняшней даты недоступные времена скрыты
4. **Прогресс-бар**: Визуально показывает текущий шаг процесса
5. **Валидация**: Все формы валидируются перед отправкой
6. **Background tasks**: Email подтверждения отправляется асинхронно


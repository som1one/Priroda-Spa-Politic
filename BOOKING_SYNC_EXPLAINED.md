# Синхронизация записей и начисление баллов

## Как это работает

### 1. Уникальный код пользователя

Каждому пользователю автоматически присваивается **уникальный код** (например: `ABC12345`), который используется для привязки записей из YClients к пользователю.

**Где хранится:**
- В таблице `users` в поле `unique_code`
- Генерируется автоматически при первом запросе формы записи

**Как используется:**
- Добавляется в комментарий формы YClients: `"Код клиента: ABC12345"`
- При синхронизации записей система ищет пользователя по этому коду

### 2. Синхронизация записей

Записи синхронизируются двумя способами:

#### A. Webhook (мгновенно)
- YClients отправляет уведомление при создании/изменении записи
- Endpoint: `POST /api/v1/yclients/webhook`
- **Настройка:** YClients → Настройки → Интеграции → Webhooks → Добавить URL

#### B. Периодическая синхронизация (каждые 30 минут)
- Автоматическая задача синхронизирует записи за последние 30 дней
- Запускается через APScheduler в `main.py`

### 3. Поиск пользователя при синхронизации

Система ищет пользователя в следующем порядке:

1. **По уникальному коду** из комментария записи
   - Формат: `"Код клиента: ABC12345"`
   - Самый надежный способ

2. **По email** из данных клиента YClients
   - Точное совпадение

3. **По телефону** из данных клиента YClients
   - Поиск по последним 10 цифрам

### 4. Начисление баллов

Баллы начисляются автоматически при синхронизации записи:

**Условия:**
- ✅ Запись имеет статус `COMPLETED` (завершена)
- ✅ Баллы еще не были начислены (`loyalty_bonuses_awarded = False`)
- ✅ Включена программа лояльности (`LOYALTY_ENABLED = True`)

**Расчет:**
- Баллы = `(цена услуги / 100) * процент_кэшбека`
- Процент кэшбека зависит от уровня лояльности пользователя

**Важно:**
- Баллы начисляются **только один раз** за каждую запись
- Начисление происходит при синхронизации, когда запись получает статус `COMPLETED`

### 5. Просмотр предстоящих записей

**Endpoint:** `GET /api/v1/booking?upcoming_only=true`

**Параметры:**
- `upcoming_only=true` - только предстоящие записи
- `status=pending|confirmed` - фильтр по статусу

**Что возвращается:**
- Записи с `appointment_datetime >= сейчас`
- Статус: `PENDING` или `CONFIRMED`
- Отсортированы по дате (ближайшие первыми)

## Настройка

### 1. Миграция базы данных

```bash
cd backend
alembic upgrade head
```

Это добавит поле `unique_code` в таблицу `users` и сгенерирует коды для существующих пользователей.

### 2. Генерация кодов для существующих пользователей

Если нужно сгенерировать коды вручную:

```bash
cd backend
python scripts/generate_unique_codes.py
```

### 3. Настройка Webhook в YClients

1. Перейдите в YClients: **Настройки → Интеграции → Webhooks**
2. Нажмите **"Добавить URL"**
3. Укажите URL: `https://ваш-домен.com/api/v1/yclients/webhook`
4. Выберите события:
   - ✅ Создание записи
   - ✅ Изменение записи
   - ✅ Отмена записи
5. Сохраните

### 4. Проверка синхронизации

**Ручная синхронизация:**
```bash
curl -X POST "http://localhost:8000/api/v1/yclients/sync-bookings" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Проверка записей пользователя:**
```bash
curl "http://localhost:8000/api/v1/booking?upcoming_only=true" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Примеры

### Пример 1: Запись через форму

1. Пользователь открывает форму YClients
2. В комментарии автоматически добавляется: `"Код клиента: ABC12345"`
3. Пользователь заполняет форму и создает запись
4. YClients отправляет webhook
5. Система находит пользователя по коду `ABC12345`
6. Создается запись в локальной БД
7. После завершения услуги начисляются баллы

### Пример 2: Синхронизация существующих записей

1. Периодическая задача получает записи из YClients за последние 30 дней
2. Для каждой записи:
   - Ищет пользователя по коду/email/телефону
   - Создает или обновляет запись в БД
   - Начисляет баллы, если запись завершена

## Troubleshooting

### Записи не синхронизируются

1. Проверьте, что `YCLIENTS_ENABLED=True` в `.env`
2. Проверьте логи бэкенда на наличие ошибок
3. Убедитесь, что webhook настроен в YClients
4. Проверьте, что пользователь имеет `unique_code`

### Баллы не начисляются

1. Проверьте, что `LOYALTY_ENABLED=True` в `.env`
2. Убедитесь, что запись имеет статус `COMPLETED`
3. Проверьте, что `loyalty_bonuses_awarded=False` (баллы еще не начислены)
4. Проверьте логи на наличие ошибок начисления

### Пользователь не находится при синхронизации

1. Проверьте, что в комментарии записи есть `"Код клиента: ..."`
2. Убедитесь, что email/телефон в YClients совпадает с данными пользователя
3. Проверьте логи синхронизации для деталей


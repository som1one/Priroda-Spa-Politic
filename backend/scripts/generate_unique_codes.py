"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""
import sys
import os
import secrets

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy import create_engine, text
from app.core.config import settings


def generate_unique_code():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞"""
    return secrets.token_urlsafe(6)[:8].upper().replace('-', '').replace('_', '')


def main():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∫–æ–¥–∞"""
    engine = create_engine(settings.DATABASE_URL)
    
    with engine.begin() as conn:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∫–æ–¥–∞
        users = conn.execute(text("SELECT id FROM users WHERE unique_code IS NULL")).fetchall()
        
        if not users:
            print("‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –∏–º–µ—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã")
            return
        
        print(f"üìã –ù–∞–π–¥–µ–Ω–æ {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞")
        
        updated = 0
        for user_id, in users:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥
            while True:
                code = generate_unique_code()
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
                existing = conn.execute(
                    text("SELECT id FROM users WHERE unique_code = :code"),
                    {"code": code}
                ).fetchone()
                if not existing:
                    break
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conn.execute(
                text("UPDATE users SET unique_code = :code WHERE id = :user_id"),
                {"code": code, "user_id": user_id}
            )
            updated += 1
            print(f"  ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}: {code}")
        
        print(f"\n‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ {updated} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")


if __name__ == "__main__":
    main()

